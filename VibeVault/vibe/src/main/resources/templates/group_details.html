<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Details</title>
</head>
<body>

<nav>
  <a th:href="@{'/groups?username=' + ${user.userName}}">Back to Groups</a> |
  <a th:href="@{'/profile?username=' + ${user.userName}}">My Profile</a>
</nav>

<div class="container mt-4">
  <h1 th:text="${group.groupName}">Group Name</h1>
  <p th:text="${group.description}">Group Description</p>

  <h3>Tags</h3>
  <div>
    <span th:each="tag : ${group.tags}" th:text="${tag.name} + ' '" class="badge badge-secondary"></span>
    <p th:if="${group.tags.size() == 0}">No tags added yet.</p>
  </div>

  <form th:action="@{'/groups/' + ${group.id} + '/add-tag'}" method="post" class="form-inline mt-3">
    <label for="tag" class="mr-2">Add Tag:</label>
    <input type="text" id="tag" name="tag" class="form-control mr-2" placeholder="Enter tag name" required>
    <input type="hidden" name="username" th:value="${user.userName}"/>
    <button type="submit" class="btn btn-primary">Add Tag</button>
  </form>

  <form th:action="@{'/groups/' + ${group.id} + '/remove-tag'}" method="post" class="form-inline mt-3">
    <label for="removeTag" class="mr-2">Remove Tag:</label>
    <select id="removeTag" name="tag" class="form-control mr-2" required>
      <option th:each="tag : ${group.tags}" th:value="${tag.name}" th:text="${tag.name}"></option>
    </select>
    <input type="hidden" name="username" th:value="${user.userName}"/>
    <button type="submit" class="btn btn-danger">Remove Tag</button>
  </form>

  <h3 class="mt-4">Members</h3>
  <ul>
    <li th:each="member : ${group.members}">
      <span th:text="${member.userName}"></span>

      <div th:if="${user.userName == group.admin.userName && member.userName != group.admin.userName}">
        <form th:action="@{'/groups/' + ${group.id} + '/remove-user'}" method="post" style="display:inline;">
          <input type="hidden" name="username" th:value="${member.userName}" />
          <input type="hidden" name="currentUser" th:value="${user.userName}" />
          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove this user?');">Remove</button>
        </form>
      </div>
    </li>
  </ul>


  <p>Members: <span th:text="${currentMemberCount}"></span> / <span th:text="${maxMembers}"></span></p>
  <p th:if="${group.members.size() == 0}">No members in this group yet.</p>

  <div th:if="${currentMemberCount < maxMembers}">
    <form th:action="@{'/groups/' + ${group.id} + '/invite'}" method="post" class="form-inline mt-3">
      <label for="inviteUser" class="mr-2">Invite User:</label>
      <input type="text" id="inviteUser" name="username" class="form-control mr-2" placeholder="Username" required>
      <input type="hidden" name="currentUser" th:value="${user.userName}" />
      <button type="submit" class="btn btn-success">Invite</button>
    </form>
  </div>
  <p th:if="${currentMemberCount >= maxMembers}" style="color: red;">This group has reached the maximum number of members.</p>

  <h3 class="mt-4">Events</h3>
  <div th:if="${group.groupEvents.size() > 0}">
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Event Name</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="event : ${group.groupEvents}">
        <td th:text="${event.name}">Event Name</td>
        <td th:text="${#dates.format(event.date, 'yyyy-MM-dd')}">Event Date</td>
        <td>
          <!-- Show Join button if the user has not yet joined the event -->
          <div th:if="${!event.participants.contains(user)}">
            <form th:action="@{'/events/' + ${event.id} + '/join'}" method="post" style="display:inline;">
                <input type="hidden" name="username" th:value="${user.userName}" />
                <button type="submit" class="btn btn-sm btn-success">Join</button>
            </form>
          </div>
        
          <!-- Show Details button if the user has already joined the event -->
          <div th:if="${event.participants.contains(user)}">
            <a th:href="@{'/events/' + ${event.id} + '/details?username=' + ${user.userName}}" class="btn btn-sm btn-info">Details</a>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
  <p th:if="${group.groupEvents.size() == 0}">No events yet for this group.</p>

  <div th:if="${user.userName == group.admin.userName}" class="mt-4">
    <a th:href="@{'/events/create' + '(username=' + ${user.userName} + ', groupname=' + ${group.groupName} + ')'}">Create New Event</a>
    <a th:href="@{'/groups/' + ${group.id} + '/edit?username=' + ${user.userName}}" class="btn btn-sm btn-warning">Edit</a>
    <form th:action="@{'/groups/' + ${group.id} + '/delete'}" method="post" style="display:inline;">
      <input type="hidden" name="username" th:value="${user.userName}" />
      <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this group?');">Delete Group</button>
    </form>
  </div>
</div>

</body>
</html>
